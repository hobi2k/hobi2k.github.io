---
layout: post
title:  "ComfyUI 환경 완전 고정 세팅 – VNCCS 사용을 위한 삽질의 기록"
date:   2026-01-22 00:10:22 +0900
categories: ComfyUI
---

# ComfyUI 환경 완전 고정 세팅 – VNCCS 사용을 위한 삽질의 기록 
**기준 환경:** Windows 11 + StabilityMatrix + ComfyUI venv + **Python 3.10** + **Torch 2.10.0+cu128** + RTX 5080

이 글은 환경 설정과의 지옥의 사투 끝에 찾아낸 ComfyUI VNCCS 사용을 위한 팁 정리다.
먼저, AHEKOT/ComfyUI_VNCCS의 환상적인 프로젝트에 감사드린다.
환경 설정만 해결하면 정말 멋진 프로젝트다.

> 목표:  
> **ComfyUI_VNCCS(AHEKOT)** 정상 실행  
> **Impact Pack / FaceDetailer** 정상 실행  
> **Ultralytics(YOLO)** 정상 실행  
> NumPy / SciPy / OpenCV 충돌(NumPy 2.x 지뢰) 완전 차단  

## 0. 왜 이 세팅이 필요한가?

ComfyUI에서 커스텀 노드들이 자주 깨지는 이유는 대부분 아래 중 하나다.

- **NumPy 2.x 설치됨**
  - `A module that was compiled using NumPy 1.x cannot be run in NumPy 2.x`
  - `numpy.core.multiarray failed to import`
  - `AttributeError: _ARRAY_API not found`
- **OpenCV가 꼬여서 cv2 기능이 정상 로딩되지 않음**
  - `cv2 has no attribute imshow`
  - `cannot import name setNumThreads from cv2`
  - `cv2 has no attribute getBuildInformation`
- Torch/torchaudio/torchvision 버전이 서로 불일치
  - `torchaudio requires torch==...`
- pip dependency resolver 경고 발생
  - `ERROR: pip's dependency resolver does not currently take into account ...`

특히 **OpenCV 설치 과정에서 NumPy 2.x가 같이 깔려버리는 게 핵폭탄**이다.  
따라서 아래처럼 **버전을 강제로 고정**해야 한다.

## 1. 최종 목표 버전 조합 (고정 셋)

아래 조합이 핵심이다.

### 필수 고정 버전


| 컴포넌트 | 버전 |
|---|---|
| Python | **3.10.x** |
| torch | **2.10.0+cu128** |
| torchvision | **0.25.0+cu128** |
| torchaudio | **2.10.0+cu128** |
| numpy | **1.26.4** |
| scipy | **1.11.4** |
| opencv-contrib-python | **4.9.0.80** |
| opencv-python-headless | **4.9.0.80** (필요시) |
| ultralytics | **8.4.7** |

> StabilityMatrix 패키지 페이지에서 ComfyUI에서
> `+` 버튼을 눌러 파이썬 패키지를 누른 후 아래 두 명령어를 살포시 실행해 주자.

```python
torch==2.10.0+cu128 torchvision==0.25.0+cu128 torchaudio==2.10.0+cu128 `
--index-url https://download.pytorch.org/whl/cu128
```

```python
numpy==1.26.4 scipy==1.11.4 opencv-contrib-python==4.9.0.80
```

ComfyUI Manager로 노드 설치하면서 자동으로 패키지가 업데이트되면,
아래를 참고해서 수동으로 설치해 주면 된다.

> 주의  
> Ultralytics는 메타데이터 상 `torch<2.10` 을 요구하는 경우가 있는데  
> pip에서 충돌 경고는 나도 실사용은 가능한 경우가 많다.  
> 목표는 “경고 제거”가 아니라 **VNCCS + FaceDetailer + YOLO가 동시에 실행되는 것**이다.

## 2. 작업 전 준비

### 2-1. ComfyUI 폴더로 이동 및 venv 활성화

```powershell
cd "D:\Stable Diffusion\StabilityMatrix-win-x64\Data\Packages\ComfyUI"
.\venv\Scripts\activate
```

### 2-2. ComfyUI / Python 완전 종료

ComfyUI가 켜져있거나 python이 백그라운드로 남아있으면
cv2.pyd 같은 파일이 잠겨서 pip uninstall이 실패한다.

```powershell
taskkill /F /IM python.exe
taskkill /F /IM pythonw.exe
```

## 3. 8188 포트 점유 프로세스 강제 종료

ComfyUI 기본 포트는 8188이다.
이미 실행 중이면 아래 오류가 난다.

```
OSError: [Errno 10048] ... port 8188 ...
```

### PowerShell로 8188 강제 종료
```powershell
Stop-Process -Id (Get-NetTCPConnection -LocalPort 8188).OwningProcess -Force
```

## 4. pip 기본 도구 업그레이드
설치 꼬임 방지를 위해 pip/setuptools/wheel을 먼저 올린다.

```powershell
python -m pip install -U pip setuptools wheel
```

## 5. 지뢰 패키지 제거 (NumPy/OpenCV/YOLO 관련)

### 5-1. pip uninstall로 제거 시도
```powershell
pip uninstall -y `
  numpy scipy `
  opencv-python opencv-python-headless opencv-contrib-python `
  ultralytics ultralytics-thop `
  rembg
```

## 6. OpenCV가 삭제 안 되는 경우: 수동 삭제 루트
아래 에러가 뜨면 OpenCV 파일이 잠겨있거나 권한 문제다.

```
PermissionError: [WinError 5] 액세스가 거부되었습니다: cv2.pyd

WinError 17 ... 다른 디스크 드라이브로 옮길 수 없습니다
```

이때는 pip가 못 치우는 상태라서 직접 폴더를 지워야 한다.

### 6-1. 수동 삭제 대상 폴더
아래 경로의 폴더/파일을 삭제한다.

```
...\venv\Lib\site-packages\cv2

...\venv\Lib\site-packages\opencv_python*

...\venv\Lib\site-packages\opencv_contrib_python*
```

### 6-2. PowerShell로 강제 삭제
```powershell
Remove-Item -Recurse -Force ".\venv\Lib\site-packages\cv2" -ErrorAction SilentlyContinue
Remove-Item -Recurse -Force ".\venv\Lib\site-packages\opencv_python*" -ErrorAction SilentlyContinue
Remove-Item -Recurse -Force ".\venv\Lib\site-packages\opencv_contrib_python*" -ErrorAction SilentlyContinue
```

## 7. 핵심: “기반 3대장” 먼저 고정 설치
여기서부터 설치 순서가 절대 중요하다.

### 7-1. NumPy + SciPy 고정 설치
```powershell
pip install --no-cache-dir --force-reinstall numpy==1.26.4 scipy==1.11.4
```

설치 확인:

```powershell
python -c "import numpy, scipy; print(numpy.__version__, scipy.__version__)"
```

기대 결과:

```
1.26.4 1.11.4
```

### 7-2. OpenCV는 반드시 --no-deps로 설치
OpenCV 설치에서 dependencies를 허용하면
NumPy 2.x가 자동으로 깔리며 다시 전부 깨진다.

```powershell
pip install --no-cache-dir --force-reinstall --no-deps opencv-contrib-python==4.9.0.80
```

확인:

```powershell
python -c "import cv2, numpy; print('cv2', cv2.__version__); print('numpy', numpy.__version__)"
```

기대 결과:

```
cv2 4.9.0

numpy 1.26.4
```

## 8. Torch 2.10.0 + cu128 강제 고정 설치

### 8-1. Torch / TorchVision / TorchAudio 세트 설치
```powershell
pip install --no-cache-dir --force-reinstall `
  torch==2.10.0+cu128 `
  torchvision==0.25.0+cu128 `
  torchaudio==2.10.0+cu128 `
  --index-url https://download.pytorch.org/whl/cu128
```

설치 확인:

```powershell
python -c "import torch; print(torch.__version__); print(torch.cuda.is_available()); print(torch.version.cuda)"
```

기대 결과:

```
torch: 2.10.0+cu128

cuda available: True
```

## 9. Ultralytics(YOLO) 설치
```powershell
pip install --no-cache-dir ultralytics==8.4.7
```

## 10. 추가 보강 패키지 (Impact Pack / VNCCS 안정화)
Impact Pack / VNCCS / 기타 커스텀 노드들은 종종 기본 패키지를 추가로 요구한다.

```powershell
pip install --no-cache-dir pillow tqdm pyyaml matplotlib
```

## 11. 최종 환경 점검 (한 번에 확인)
아래 명령으로 NumPy/SciPy/OpenCV/Torch/CUDA가 동시에 정상인지 체크한다.

```powershell
python -c "import numpy, scipy, cv2, torch; print('numpy', numpy.__version__); print('scipy', scipy.__version__); print('cv2', cv2.__version__); print('torch', torch.__version__); print('cuda', torch.cuda.is_available())"
```

합격 기준:

- numpy = 1.26.4
- scipy = 1.11.4
- cv2 = 4.9.0
- torch = 2.10.0+cu128
- cuda = True

## 12. ComfyUI 실행
```powershell
python main.py --preview-method auto --use-pytorch-cross-attention
```

## 13. VNCCS 설치 위치 확인
VNCCS는 pip 패키지가 아니라 ComfyUI 커스텀 노드 폴더에 있어야 한다.

목표 경로:

```makefile
D:\Stable Diffusion\StabilityMatrix-win-x64\Data\Packages\ComfyUI\custom_nodes\ComfyUI_VNCCS
```

## 14. 흔히 나오는 에러와 원인 요약
### 14-1. A module compiled with NumPy 1.x cannot be run in NumPy 2.x
- 원인: NumPy 2.x 설치됨
- 해결: numpy==1.26.4로 고정하고 OpenCV는 --no-deps

### 14-2. Torch not compiled with CUDA enabled
- 원인: CPU용 torch 설치됨
- 해결: 반드시 cu128 wheel로 재설치

```powershell
pip install --force-reinstall torch==2.10.0+cu128 --index-url https://download.pytorch.org/whl/cu128
```

### 14-3. cv2 has no attribute imshow / getBuildInformation
- 원인: OpenCV가 깨졌거나 “다른 OpenCV 패키지와 섞여서” 로딩됨
- 해결: OpenCV 전부 제거 후 opencv-contrib-python 4.9.0.80을 --no-deps로 설치

### 14-4. pip dependency resolver conflicts
- 원인: 설치된 패키지들의 메타데이터 충돌
- 결론: 경고는 나도 실행만 되면 OK
(진짜 문제는 ImportError / AttributeError)

## 15. 최종 운영 원칙 (중요)

앞으로 절대 하지 말아야 할 것 3가지

- pip install opencv-contrib-python을 deps 허용하고 설치
- pip install -r requirements.txt를 아무 생각 없이 실행
- "자동 설치 기능"으로 여러 노드를 한 번에 설치

앞으로 해야 할 것

- OpenCV는 무조건 --no-deps
- NumPy는 무조건 1.26.4
- Torch는 무조건 2.10.0+cu128 세트 일치

## 부록: 완전 복구용 “원라인” 설치 순서 요약
```powershell
cd "D:\Stable Diffusion\StabilityMatrix-win-x64\Data\Packages\ComfyUI"
.\venv\Scripts\activate

taskkill /F /IM python.exe
taskkill /F /IM pythonw.exe

python -m pip install -U pip setuptools wheel

pip uninstall -y numpy scipy opencv-python opencv-python-headless opencv-contrib-python ultralytics ultralytics-thop rembg

pip install --no-cache-dir --force-reinstall numpy==1.26.4 scipy==1.11.4
pip install --no-cache-dir --force-reinstall --no-deps opencv-contrib-python==4.9.0.80

pip install --no-cache-dir --force-reinstall `
  torch==2.10.0+cu128 torchvision==0.25.0+cu128 torchaudio==2.10.0+cu128 `
  --index-url https://download.pytorch.org/whl/cu128

pip install --no-cache-dir ultralytics==8.4.7
pip install --no-cache-dir pillow tqdm pyyaml matplotlib

python -c "import numpy, scipy, cv2, torch; print(numpy.__version__, scipy.__version__, cv2.__version__, torch.__version__, torch.cuda.is_available())"

python main.py --preview-method auto --use-pytorch-cross-attention
```

참고 자료 
https://github.com/AHEKOT/ComfyUI_VNCCS